!function(t){function e(e){for(var r,s,a=e[0],c=e[1],u=e[2],l=0,p=[];l<a.length;l++)s=a[l],Object.prototype.hasOwnProperty.call(n,s)&&n[s]&&p.push(n[s][0]),n[s]=0;for(r in c)Object.prototype.hasOwnProperty.call(c,r)&&(t[r]=c[r]);for(_&&_(e);p.length;)p.shift()();return i.push.apply(i,u||[]),o()}function o(){for(var t,e=0;e<i.length;e++){for(var o=i[e],r=!0,a=1;a<o.length;a++){var c=o[a];0!==n[c]&&(r=!1)}r&&(i.splice(e--,1),t=s(s.s=o[0]))}return t}var r={},n={"web/story_publisher":0},i=[];function s(e){if(r[e])return r[e].exports;var o=r[e]={i:e,l:!1,exports:{}};return t[e].call(o.exports,o,o.exports,s),o.l=!0,o.exports}s.e=function(){return Promise.resolve()},s.m=t,s.c=r,s.d=function(t,e,o){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(s.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)s.d(o,r,function(e){return t[e]}.bind(null,r));return o},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="/js/cmodules/";var a=window.webpackJsonp=window.webpackJsonp||[],c=a.push.bind(a);a.push=e,a=a.slice();for(var u=0;u<a.length;u++)e(a[u]);var _=c;i.push([305,"common","palette","b2b4a606844efe3a7e103ba3cbe86321","7441004f6b6b66cce39929ceed1ae0cd","9b69690c2f17eb6642dea9531af86fbd"]),o()}({305:function(t,e,o){t.exports=o("8o6h")},"8o6h":function(t,e,o){"use strict";o.r(e);var r=o("qJhe");window.StoryPublisher=r.StoryPublisher;try{window.stManager.done(window.jsc("web/story_publisher.js"))}catch(t){}},bKAG:function(t,e,o){"use strict";o.r(e),o.d(e,"MAX_STORY_VIDEO_DURATION",(function(){return u})),o.d(e,"StoryType",(function(){return r})),o.d(e,"StoryEntryPoint",(function(){return n})),o.d(e,"StorySource",(function(){return i})),o.d(e,"getStoryUploadUrl",(function(){return _})),o.d(e,"uploadStoryBlobToServer",(function(){return l})),o.d(e,"saveStoryOnServer",(function(){return p}));var r,n,i,s=o("jE6c"),a=o("PU8N"),c=function(){return(c=Object.assign||function(t){for(var e,o=1,r=arguments.length;o<r;o++)for(var n in e=arguments[o])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)},u=16;function _(t){return new Promise((function(e,o){window.ajax.post(Object(a.isMvk)()?"stories.php":"al_stories.php",c({act:"get_upload_url"},t),{onDone:e,onError:o,onFail:o})}))}function l(t,e){var o=new FormData,r=encodeURIComponent("edited_"+Object(s.irand)(0,99999)+".jpg");return o.append("file0",t,r),fetch(e,{method:"POST",body:o}).then((function(t){return t.json()}))}function p(t,e){return new Promise((function(o,r){window.ajax.post(Object(a.isMvk)()?"stories.php":"al_stories.php",{act:"save",upload_result:t,hash:e},{onDone:o,onError:r,onFail:r})}))}!function(t){t.PHOTO="photo",t.VIDEO="video"}(r||(r={})),function(t){t.SWIPE="swipe",t.NAVIGATION_BUTTON="navigation_button",t.SIT_POSTING="sit_posting",t.LINK="link",t.STORY_REPLY="story_reply",t.STORY_REPOST="story_repost",t.CATALOG_ADD="catalog_add",t.DIALOG="dialog",t.STORY_LIVE_FINISHED="story_live_finished",t.DIALOG_VKME="dialog_vkme",t.STORY_VIEWER_FINISHED="story_viewer_finished",t.PUSH_TRY_MASK="push_try_mask",t.STORY_VIEWER_TRY_MASK="story_viewer_try_mask",t.LINK_MASK="link_mask",t.POSTING="posting",t.NEW_STORY_AVATAR="new_story_avatar",t.STORY_REPLIES_LIST="story_replies_list",t.STORIES_FEED="stories_feed",t.STORIES_SEARCH_NEWS="stories_search_news",t.QUESTION_STICKER="question_sticker",t.LIST_MIDDLE="list_middle",t.ARCHIVE_EMPTY_BUTTON="archive_empty_button",t.ARCHIVE_MENU_BUTTON="archive_menu_button",t.IM="im",t.PROFILE_BUTTON="profile_button",t.SHARE="share",t.MINI_APP="mini_app",t.SYSTEM_SHARING="system_sharing",t.SHORTCUT="shortcut",t.ARCHIVE_SHARING="archive_sharing",t.STORY_VIEWER_CAMERA_BUTTON="story_viewer_camera_button",t.STORY_VIEWER_MUSIC="story_viewer_music",t.STORY_VIEWER_MUSIC_SHEET="story_viewer_music_sheet",t.REPOST_TO_STORY_ACTIVITY="repost_to_story_activity",t.CHANGE_AVATAR="change_avatar"}(n||(n={})),function(t){t.FEED="feed",t.FEED_MIDDLE="feed_middle",t.LINK="link",t.PROFILE="profile",t.IM_DIALOGS="im_dialogs",t.IM_DIALOG_HEADER="im_dialog_header",t.SNIPPET="snippet",t.REPLY="reply",t.REPLIES_LIST="replies_list",t.REPLY_STORY="reply_story",t.DISCOVER="discover",t.STORIES_MANAGE="stories_manage",t.USER_PERSONAL_CARD="user_personal_card",t.GROUP_PERSONAL_CARD="group_personal_card",t.NARRATIVE_SNIPPET="narrative_snippet",t.NARRATIVE_STORY="narrative_story",t.NARRATIVE_LINK="narrative_link",t.NARRATIVE_RECOMMENDATIONS="narrative_recommendations",t.NARRATIVE_SECTION="narrative_section",t.FAVE="fave",t.SPAMFEED="sf",t.ADS_PREVIEW="ads_preview",t.LIST_MIDDLE="list_middle",t.PLACE_STORY_LIST="place_story_list",t.SEARCH_STORY_LIST="search_story_list",t.STORY_ARCHIVE="story_archive",t.IM_MSG_LIST="im_msg_list",t.NOSPAM="nospam",t.PROFILE_SNACKBAR="profile_snackbar"}(i||(i={}))},qJhe:function(t,e,o){"use strict";o.r(e),o.d(e,"StoryPublisher",(function(){return h}));var r,n=o("q1tI"),i=o("i8i4"),s=o("0fW4"),a=o("EasH"),c=o("6krn"),u=(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])})(t,e)},function(t,e){function o(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}),_=o("e87a").default,l=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.errorHandler=function(t,e){var o=t||Object(c.getLang)("global_error");window.showFastBox({title:Object(c.getLang)("global_error")},o,Object(c.getLang)("global_close"),(function(){e(),window.curBox().hide()}))},e.save=function(t,o,r){var n;void 0===r&&(r={}),e.props.onClickSave(),window.StoryPublisher.saveStory(t,{attachment:JSON.stringify(e.props.attachment),clickable_stickers:r.clickableStickers,mini_app_id:e.props.miniAppId,situational_suggest_id:null===(n=e.props.serviceInfo)||void 0===n?void 0:n.situational_suggest_id,analytics:r.analytics,mediaEditorAnalytics:r.mediaEditorAnalytics,hash:r.storyUploadUrlHash,entry_point:e.props.entrypoint,ref:window.cur.module},r.storySaveHash).then((function(t){e.onClose(!0,!1,t),o()})).catch((function(t){return e.errorHandler(t,o),!0}))},e.onClose=function(t,o,r){var n,i;if(o)e.props.onClose(!1);else if(t)window.Stories&&window.Stories.updateFeedStories&&window.Stories.updateFeedStories(),e.props.onClose(!0,r);else{(null===(i=null===(n=window.cur.photoEditorStore)||void 0===n?void 0:n.getState())||void 0===i?void 0:i.past.length)>1?Object(a.showFastBox)({title:Object(c.getLang)("photos_pe_story_editor_close_title"),bodyStyle:"padding: 20px; line-height: 160%;",dark:1,forceNoBtn:1,onShow:function(){window.cur._noEscHide=!0},onClean:function(){window.cur._noEscHide=!1}},Object(c.getLang)("photos_pe_story_editor_close_text"),Object(c.getLang)("box_yes"),(function(){e.props.onClose(!1),window.curBox().hide()}),Object(c.getLang)("box_no"),(function(){window.curBox().hide()})):e.props.onClose(!1)}},e}return u(e,t),e.prototype.render=function(){var t=this,e=Math.min(900,window.innerHeight-100),o=e/1.78;return n.createElement(_,{disableBodyScroll:!0,onClose:function(){return t.onClose()}},n.createElement(s.default,{context:"story",photoUrl:this.props.photoUrl,artboardWidth:o,artboardHeight:e,save:this.save,close:function(){return t.onClose()},attachment:this.props.attachment,stickers:this.props.stickers,serviceInfo:this.props.serviceInfo}))},e}(n.Component),p=o("ufMw"),d=o("kcIO"),S=o("4+be"),f=o("bKAG"),h={init:function(t,e,o){var r=this;this.onClickSave=e||function(){},this.cb=o,this.loadStatic().then((function(){r.render(t)})).catch((function(t){console.error(t)}))},loadStatic:function(){return window.stManager.add([window.jsc("web/story_publisher.js"),"photo_editor.css"])},render:function(t){var e=(null==t?void 0:t.entrypoint)||"",o=(null==t?void 0:t.miniAppId)||0;window.cur.storyPublishContext=!0,"story_repost"===e?Object(p.sendStat)(p.EVENTS.ADD_STORY_FROM_SHARING):Object(p.sendStat)(p.EVENTS.ADD_STORY);var r=document.querySelector(".StoryPublisher");r||((r=document.createElement("div")).classList.add("StoryPublisher"),document.body.append(r)),i.render(n.createElement(l,{entrypoint:e,miniAppId:o,onClose:this.destroy.bind(this),onClickSave:this.onClickSave.bind(this),photoUrl:null==t?void 0:t.photoUrl,attachment:null==t?void 0:t.attachment,stickers:null==t?void 0:t.stickers,serviceInfo:null==t?void 0:t.serviceInfo}),r)},destroy:function(t,e){var o=document.querySelector(".StoryPublisher");o&&i.unmountComponentAtNode(o),this.cb&&this.cb(t,e),delete window.cur.photoEditorStore,t&&Object(d.showDoneBox)(Object(S.getLang)("photos_pe_story_published"))},saveStory:function(t,e,o){return Object(f.getStoryUploadUrl)(e).then((function(e){return Object(f.uploadStoryBlobToServer)(t,e)})).then((function(t){var e=t.response;return Object(f.saveStoryOnServer)(e&&e.upload_result,o)}))}}},yLpj:function(t,e){var o;o=function(){return this}();try{o=o||new Function("return this")()}catch(t){"object"==typeof window&&(o=window)}t.exports=o}});